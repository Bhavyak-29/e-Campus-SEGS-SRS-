<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Dhirubhai Ambani - Institute of Information and Communication Technology
    </title>
    <link rel="stylesheet" th:href="@{/css/ecampus.css}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body onload="firstComboFill()">
    <div th:insert="fragments/header :: mainHeader"></div>
    <div class="container mt-5 text-center position-relative">
  <a th:href="@{/auth/homepage}" class="btn btn-primary position-absolute start-0 ms-3">
    Go Back
  </a>
</div>

    
    <div class="container my-5">
      <div class="card shadow p-4 mx-auto" style="max-width: 600px;">
        <form name="exam_Form1" method="GET" th:action="${targetUrl}">
          <div class="mb-3">
            <label for="academicYearId" class="form-label fw-bold">Academic Year</label>
            <select
              class="form-select"
              name="academicYearId"
              id="academicYearId"
              onchange="comboSelect(1, this)"
            >
              <option value="">Select</option>
              <option
                th:each="item : ${academicYears}"
                th:value="${item.id}"
                th:text="${item.name}"
              ></option>
            </select>
          </div>

          <div class="mb-3">
            <label for="termId" class="form-label fw-bold">Term Name</label>
            <select
              class="form-select"
              name="termId"
              id="termId"
              onchange="comboSelect(2, this)"
            >
              <option value="">Select</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="termCourseId" class="form-label fw-bold">Course Name</label>
            <select
              class="form-select"
              name="termCourseId"
              id="termCourseId"
              onchange="comboSelect(3, this)"
            >
              <option value="">Select</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="examTypeId" class="form-label fw-bold">Exam Type</label>
            <select class="form-select" name="examTypeId" id="examTypeId">
              <option value="">Select</option>
            </select>
          </div>

          <div class="d-grid">
            <button type="button" class="btn btn-primary fw-bold" onclick="submitIt()">
              Next &raquo;
            </button>
          </div>
        </form>

        <div th:if="${errorMessage}" class="text-danger text-center mt-3">
          <p th:text="${errorMessage}"></p>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/

      function comboSelect(comboNo, combo) {
        var comboBox1 = document.forms[0].academicYearId;
        var comboBox2 = document.forms[0].termId;
        var comboBox3 = document.forms[0].termCourseId;
        var comboBox4 = document.forms[0].examTypeId;

        if (comboNo === 1) {
          removeChildComboOptions(2);
        } else if (comboNo === 2) {
          removeChildComboOptions(3);
        } else if (comboNo === 3) {
          removeChildComboOptions(4);
        }

        if (combo.selectedIndex > 0) {
          var selectedId = combo.options[combo.selectedIndex].value;
          var url;
          var params;

          if (comboNo === 1) {
            url = /*[[@{/results/coursewise/exam-specific/api/terms}]]*/ "";
            params = new URLSearchParams({ academicYearId: selectedId });
            fetchAndFillCombo(comboBox2, url, params, 2);
          } else if (comboNo === 2) {
            url = /*[[@{/results/coursewise/exam-specific/api/courses}]]*/ "";
            params = new URLSearchParams({ termId: selectedId });
            fetchAndFillCombo(comboBox3, url, params, 3);
          } else if (comboNo === 3) {
            url = /*[[@{/results/coursewise/exam-specific/api/examtypes}]]*/ "";
            params = new URLSearchParams({ termCourseId: selectedId });
            fetchAndFillCombo(comboBox4, url, params, 4);
          }
        }
      }

      function fetchAndFillCombo(comboElement, url, params, comboNo) {
        removeChildComboOptions(comboNo); 

        fetch(url + "?" + params.toString())
          .then((response) => response.json())
          .then((data) => {
            if (data && data.length > 0) {
              data.forEach((item) => {
                comboElement.options[comboElement.options.length] = new Option(
                  item.name,
                  item.id
                );
              });
            }
          })
          .catch((error) => console.error("Error fetching data:", error));
      }

      function removeChildComboOptions(removeFrom) {
        var comboBox2 = document.forms[0].termId;
        var comboBox3 = document.forms[0].termCourseId;
        var comboBox4 = document.forms[0].examTypeId;

        if (removeFrom <= 2) {
          removeComboOptions(comboBox2);
          if (removeFrom <= 3) {
            removeComboOptions(comboBox3);
            if (removeFrom <= 4) {
              removeComboOptions(comboBox4);
            }
          }
        }
      }

      function removeComboOptions(combo) {
        while (combo.options.length > 1) {
          combo.remove(1);
        }
        combo.selectedIndex = 0; 
      }

      function submitIt() {
        var msgError = "";
        if (document.forms[0].academicYearId.selectedIndex === 0)
          msgError += "Please Select Academic Year\n";
        if (document.forms[0].termId.selectedIndex === 0)
          msgError += "Please Select Term Name\n";
        if (document.forms[0].termCourseId.selectedIndex === 0)
          msgError += "Please Select Course Name\n";
        if (document.forms[0].examTypeId.selectedIndex === 0)
          msgError += "Please Select Exam Type\n";

        if (msgError !== "") {
          alert("Error:" + msgError);
        } else {
          document.forms[0].submit();
        }
      }
      /*]]>*/
    </script>
  </body>
</html>

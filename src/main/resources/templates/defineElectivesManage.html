<!-- <!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manage Electives</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/ecampus.css}" />
    <style>
        .container { margin-top: 40px; max-width: 900px; }
        .header { margin-bottom: 30px; }
        .table td, .table th { vertical-align: middle; }
        #courseTable { margin-top: 20px; }
        .btn-modern { border-radius: 8px; }
    </style>
</head>

<body>

<div th:replace="fragments/commonHeader :: mainHeader"></div>

<div class="container">
    <div class="header text-center">
        <h3 class="fw-bold mb-3">Manage Electives</h3>
        <p>
            <strong>Program:</strong> <span th:text="${selectedProgram?.prgname}"></span><br>
            <strong>Term:</strong> <span th:text="${selectedTerm?.trmname}"></span>
        </p>
        <form th:action="@{/admin/electives/reset-term}" method="post">
            <button type="submit" class="btn btn-outline-secondary btn-sm">Change Term/Program</button>
        </form>
    
    </div>

    <div class="form-group mb-4">
        <label for="courseGroupSelect" class="form-label fw-bold">Select Course Group:</label>
        <select id="courseGroupSelect" class="form-select w-50 mx-auto">
            <option value="">-- Select Elective Group --</option>
            <option th:each="cg : ${courseGroups}"
                    th:value="${cg.cgpid}"
                    th:text="${cg.cgpname}"></option>
        </select>
    </div>

    <div id="courseSection" style="display:none;">
        <h5 class="fw-semibold text-center mb-3">Courses in this Group</h5>

        <table id="courseTable" class="table table-bordered table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th>Course Code</th>
                    <th>Course Name</th>
                    <th>Active</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="d-flex justify-content-between mt-3">
            <button class="btn btn-success btn-modern" id="addCourseBtn">+ Add New Course</button>
            <button class="btn btn-primary btn-modern" id="saveChangesBtn">Save Changes</button>
        </div>
    </div>
</div>

<script th:inline="javascript">
const prgid = /*[[${selectedProgram != null ? selectedProgram.prgid : 0}]]*/ 0;
const trmid = /*[[${selectedTerm != null ? selectedTerm.trmid : 0}]]*/ 0;

document.getElementById('courseGroupSelect').addEventListener('change', async function() {
    const cgpid = this.value;
    if (!cgpid) return;

    const res = await fetch(`/admin/electives/courses?cgpid=${cgpid}&prgid=${prgid}`);
    const courses = await res.json();

    const tbody = document.querySelector('#courseTable tbody');
    tbody.innerHTML = '';

    courses.forEach(c => {
        tbody.innerHTML += `
            <tr>
                <td>${c.crscode}</td>
                <td>${c.crsname}</td>
                <td><input type="checkbox" ${c.active ? 'checked' : ''}></td>
            </tr>`;
    });

    document.getElementById('courseSection').style.display = 'block';
});

document.getElementById('addCourseBtn').addEventListener('click', () => {
    const tbody = document.querySelector('#courseTable tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="text" placeholder="Enter Course Code" class="form-control"></td>
        <td><input type="text" placeholder="Enter Course Name" class="form-control"></td>
        <td><input type="checkbox" checked></td>
    `;
    tbody.appendChild(newRow);
});

document.getElementById('saveChangesBtn').addEventListener('click', async () => {
    const cgpid = document.getElementById('courseGroupSelect').value;
    if (!cgpid) return alert('Please select a course group first.');

    const rows = document.querySelectorAll('#courseTable tbody tr');
    const updatedCourses = [];

    rows.forEach(row => {
        const code = row.querySelector('td:nth-child(1) input')?.value || row.children[0].innerText;
        const name = row.querySelector('td:nth-child(2) input')?.value || row.children[1].innerText;
        const active = row.querySelector('input[type="checkbox"]').checked;
        updatedCourses.push({ code, name, active });
    });

    const payload = { cgpid, prgid, trmid, updatedCourses };

    const res = await fetch('/admin/electives/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    if (res.ok) {
        alert('Electives updated successfully!');
    } else {
        alert('Error updating electives');
    }
});
</script>
</body>
</html> -->


<!-- <!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Define Electives for a Term</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/ecampus.css}" />


  <style>
  .container {
    margin-top: 40px;
    max-width: 1000px;
  }

  table th, table td {
    text-align: center;
    vertical-align: middle;
    position: relative;
  }

  input[type="text"] {
    width: 100%;
  }

  .faculty-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    z-index: 999;
    max-height: 180px;
    overflow-y: auto;
    display: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    border-radius: 4px;
    width: auto;
    min-width: 200px;
  }

  .faculty-suggestions div {
    padding: 6px 10px;
    cursor: pointer;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .faculty-suggestions div:hover {
    background-color: #f8f9fa;
  }

  /* Fix table overflow */
  .table-responsive {
    overflow-x: auto;
  }
</style>

</head>
<body>
<div th:replace="fragments/commonHeader :: mainHeader"></div>
<div class="container">
  <h3 class="mb-4 text-center">Define Electives for [[${termName}]] Term</h3>
<div class="table-responsive">
  <table class="table table-bordered" id="electivesTable">
    <thead class="table-light">
      <tr>
        <th>Course Code</th>
        <th>Course Name</th>
        <th>Credits</th>
        <th>Faculty</th>
        <th>Slot</th>
        <th>[Checkbox]</th>
      </tr>
    </thead>
    <tbody>
      <tr th:each="tc : ${courses}">
        <td th:text="${tc.course.crscode}"></td>
        <td th:text="${tc.course.crstitle}"></td>
        <td th:text="${tc.course.crscreditpoints}"></td>
        <td>
          <input type="text" class="faculty-input form-control" placeholder="Type faculty name">
          <div class="faculty-suggestions"></div>
        </td>
        <td>
          <select class="form-select">
            <option value="">Select</option>
            <option th:each="i : ${#numbers.sequence(1,8)}" th:value="${i}" th:text="${i}"></option>
          </select>
        </td>
        <td><input type="checkbox"></td>
      </tr>
    </tbody>
  </table>
</div>
  
  <div class="mt-3 d-flex justify-content-between">
    <button id="addRowBtn" class="btn btn-success">+ Add Row</button>
    <button id="saveBtn" class="btn btn-primary">Save</button>
  </div>
</div>



<script>
function attachFacultyAutocomplete(input) {
  input.addEventListener('input', async () => {
    const query = input.value.trim();
    const suggestionBox = input.nextElementSibling;

    if (query.length < 2) {
      suggestionBox.style.display = 'none';
      return;
    }

    try {
      const res = await fetch(`/admin/defineElectives/faculty/search?q=${query}`);
      if (!res.ok) return;
      const data = await res.json();

      suggestionBox.innerHTML = '';
      data.forEach(fac => {
        const div = document.createElement('div');
        div.textContent = fac.name;
        div.onclick = () => {
          input.value = fac.name;
          suggestionBox.style.display = 'none';
        };
        suggestionBox.appendChild(div);
      });
      suggestionBox.style.display = data.length ? 'block' : 'none';
    } catch (e) {
      console.error('Faculty search failed:', e);
    }
  });
}


document.querySelectorAll('.faculty-input').forEach(attachFacultyAutocomplete);

document.getElementById('addRowBtn').addEventListener('click', () => {
  const tbody = document.querySelector('#electivesTable tbody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="text" class="form-control" placeholder="Course Code"></td>
    <td><input type="text" class="form-control" placeholder="Course Name"></td>
    <td><input type="number" class="form-control" placeholder="Credits"></td>
    <td>
      <input type="text" class="faculty-input form-control" placeholder="Type faculty name">
      <div class="faculty-suggestions"></div>
    </td>
    <td>
      <select class="form-select">
        <option value="">Select</option>
        ${[1,2,3,4,5,6,7,8].map(i=>`<option value="${i}">${i}</option>`).join('')}
      </select>
    </td>
    <td><input type="checkbox" checked></td>
  `;
  tbody.appendChild(row);


  const newInput = row.querySelector('.faculty-input');
  attachFacultyAutocomplete(newInput);
});

document.getElementById('saveBtn').addEventListener('click', async () => {
  const rows = document.querySelectorAll('#electivesTable tbody tr');
  const data = [];

  rows.forEach(row => {
    const code = row.cells[0].innerText || row.cells[0].querySelector('input')?.value;
    const name = row.cells[1].innerText || row.cells[1].querySelector('input')?.value;
    const credits = row.cells[2].innerText || row.cells[2].querySelector('input')?.value;
    const faculty = row.querySelector('.faculty-input')?.value;
    const slot = row.querySelector('select')?.value;
    const selected = row.querySelector('input[type="checkbox"]').checked;

    if (selected) data.push({ code, name, credits, faculty, slot });
  });

  const res = await fetch('/admin/defineElectives/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  if (res.ok) alert('Saved successfully!');
  else alert('Error saving electives.');
});
</script>

</body>
</html> -->

<!-- <!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Define Electives for a Term</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" th:href="@{/css/ecampus.css}" />

  <style>
    .container { margin-top: 40px; max-width: 1000px; }
    table th, table td { text-align: center; vertical-align: middle; position: relative; }
    input[type="text"] { width: 100%; }

    .faculty-suggestions {
      position: absolute; top: 100%; left: 0; right: 0;
      background: white; border: 1px solid #ccc;
      z-index: 999; max-height: 180px; overflow-y: auto;
      display: none; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-radius: 4px; width: auto; min-width: 200px;
    }
    .faculty-suggestions div {
      padding: 6px 10px; cursor: pointer; text-align: left;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .faculty-suggestions div:hover { background-color: #f8f9fa; }

    .course-suggestions {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      z-index: 999;
      width: 100%;
      max-height: 180px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-radius: 4px;
    }

    .course-suggestions div {
      padding: 6px 10px;
      cursor: pointer;
      text-align: left;
    }

    .course-suggestions div:hover {
      background-color: #f8f9fa;
    }

    .table-responsive { overflow-x: auto; }
  </style>
</head>

<body>
<div th:replace="fragments/commonHeader :: mainHeader"></div>
<div class="container">
  <h3 class="mb-4 text-center">Define Electives for [[${termName}]] Term</h3>

  <div class="table-responsive">
    <table class="table table-bordered" id="electivesTable">
      <thead class="table-light">
        <tr>
          <th>Course Code</th>
          <th>Course Name</th>
          <th>Credits</th>
          <th>Faculty</th>
          <th>Slot</th>
          <th>[Checkbox]</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="tc : ${courses}">
          <td th:text="${tc.course.crscode}"></td>
          <td th:text="${tc.course.crstitle}"></td>
          <td th:text="${tc.course.crscreditpoints}"></td>
          <td>
            <input type="text" class="faculty-input form-control" placeholder="Type faculty name">
            <div class="faculty-suggestions"></div>
          </td>
          <td>
            <select class="form-select">
              <option value="">Select</option>
              <option th:each="i : ${#numbers.sequence(1,8)}" th:value="${i}" th:text="${i}"></option>
            </select>
          </td>
          <td><input type="checkbox"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="mt-3 d-flex justify-content-between">
    <button id="addRowBtn" class="btn btn-success">+ Add Row</button>
    <button id="saveBtn" class="btn btn-primary">Save</button>
  </div>
</div>

<script>
function attachFacultyAutocomplete(input) {
  input.addEventListener('input', async () => {
    const query = input.value.trim();
    const suggestionBox = input.nextElementSibling;

    if (query.length < 2) {
      suggestionBox.style.display = 'none';
      return;
    }

    try {
      const res = await fetch(`/admin/defineElectives/faculty/search?q=${query}`);
      if (!res.ok) return;
      const data = await res.json();

      suggestionBox.innerHTML = '';
      data.forEach(fac => {
        const div = document.createElement('div');
        div.textContent = fac.name;
        div.onclick = () => {
          input.value = fac.name;
          suggestionBox.style.display = 'none';
        };
        suggestionBox.appendChild(div);
      });
      suggestionBox.style.display = data.length ? 'block' : 'none';
    } catch (e) {
      console.error('Faculty search failed:', e);
    }
  });
}

function attachCourseAutocomplete(input) {
  input.addEventListener('input', async () => {
    const query = input.value.trim();
    const suggestionBox = input.parentElement.querySelector(".course-suggestions");

    if (query.length < 2) {
      suggestionBox.style.display = 'none';
      return;
    }

    try {
      const res = await fetch(`/courses/search?q=${encodeURIComponent(query)}`);
      if (!res.ok) return;
      const data = await res.json();

      suggestionBox.innerHTML = '';
      data.forEach(course => {
        const div = document.createElement('div');
        div.textContent = `${course.crscode} - ${course.crsname} (${course.crscreditpoints} credits)`;
        div.onclick = () => {
          input.value = course.crscode;
          input.closest('tr').querySelector('.courseName').value = course.crsname;
          input.closest('tr').querySelector('.courseCredits').value = course.crscreditpoints;
          input.closest('tr').querySelector('.courseId').value = course.crsid;
          suggestionBox.style.display = 'none';
        };
        suggestionBox.appendChild(div);
      });
      suggestionBox.style.display = data.length ? 'block' : 'none';
    } catch (e) {
      console.error('Course search failed:', e);
    }
  });
}

document.querySelectorAll('.faculty-input').forEach(attachFacultyAutocomplete);

document.getElementById('addRowBtn').addEventListener('click', () => {
  const tbody = document.querySelector('#electivesTable tbody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>
      <input type="text" class="form-control courseCodeInput" placeholder="Search course">
      <div class="course-suggestions"></div>
      <input type="hidden" class="courseId">
    </td>
    <td><input type="text" class="form-control courseName" placeholder="Course Name" readonly></td>
    <td><input type="number" class="form-control courseCredits" placeholder="Credits" readonly></td>
    <td>
      <input type="text" class="faculty-input form-control" placeholder="Type faculty name">
      <div class="faculty-suggestions"></div>
    </td>
    <td>
      <select class="form-select">
        <option value="">Select</option>
        ${[1,2,3,4,5,6,7,8].map(i=>`<option value="${i}">${i}</option>`).join('')}
      </select>
    </td>
    <td><input type="checkbox" checked></td>
  `;
  tbody.appendChild(row);

  attachFacultyAutocomplete(row.querySelector('.faculty-input'));
  attachCourseAutocomplete(row.querySelector('.courseCodeInput'));
});

document.getElementById('saveBtn').addEventListener('click', async () => {
  const rows = document.querySelectorAll('#electivesTable tbody tr');
  const data = [];

  rows.forEach(row => {
    const code = row.querySelector('.courseCodeInput')?.value || row.cells[0].innerText;
    const name = row.querySelector('.courseName')?.value || row.cells[1].innerText;
    const credits = row.querySelector('.courseCredits')?.value || row.cells[2].innerText;
    const faculty = row.querySelector('.faculty-input')?.value;
    const slot = row.querySelector('select')?.value;
    const selected = row.querySelector('input[type="checkbox"]').checked;
    const crsid = row.querySelector('.courseId')?.value;

    if (selected) data.push({ crsid, code, name, credits, facultyid: faculty, slot });
  });

  const res = await fetch('/admin/defineElectives/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  if (res.ok) alert('Saved successfully!');
  else alert('Error saving electives.');
});
</script>
</body>
</html> -->

<!-- <!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Define Electives</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/ecampus.css}" />
</head>
<body>

<div th:replace="fragments/commonHeader :: mainHeader"></div>
<h2>Define Electives for Term [[${latestTermId}]]</h2>

<table id="electivesTable" border="1">
    <thead>
    <tr>
        <th>Course Code</th>
        <th>Course Name</th>
        <th>Credits</th>
        <th>Faculty</th>
        <th>Slot</th>
        <th>Delete</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="tcr : ${termCourses}">
        <td th:text="${tcr.course?.crscode}"></td>
        <td th:text="${tcr.course?.crsname}"></td>
        <td th:text="${tcr.course?.crscreditpoints}"></td>
        <td>
            <input type="text" class="facultyName" th:value="${tcr.user?.uemail}" placeholder="Search faculty">
            <input type="hidden" class="facultyId" th:value="${tcr.tcrfacultyid}">
        </td>
        <td>
            <select class="slot">
                <option th:each="i : ${#numbers.sequence(1,8)}"
                        th:value="${i}"
                        th:text="${i}"
                        th:selected="${i == tcr.tcrslot}"></option>
            </select>
        </td>
        <td><input type="checkbox" class="deleteRow"></td>
        <input type="hidden" class="tcrid" th:value="${tcr.tcrid}">
    </tr>
    </tbody>
</table>

<button id="saveBtn">Save</button>

<script>
    $("#saveBtn").on("click", function () {
        let rows = [];
        $("#electivesTable tbody tr").each(function () {
            rows.push({
                tcrid: $(this).find(".tcrid").val(),
                crsid: $(this).find(".courseId").val(),
                facultyid: $(this).find(".facultyId").val(),
                slot: $(this).find(".slot").val(),
                delete: $(this).find(".deleteRow").is(":checked")
            });
        });

        $.ajax({
            url: "/admin/defineElectives/save",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(rows),
            success: function () {
                alert("Changes saved successfully!");
                location.reload();
            },
            error: function () {
                alert("Error saving changes.");
            }
        });
    });
</script>
</body>
</html> -->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Define Electives for a Term</title>
  <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" th:href="@{/css/ecampus.css}" />
  <style>
    .container { margin-top: 20px; max-width: 1100px; }
    table th, table td { text-align: center; vertical-align: middle; position: relative; }
    .suggestions {
      position: absolute; top: 100%; left: 0; right: 0;
      background: white; border: 1px solid #ccc; z-index: 9999;
      max-height: 180px; overflow-y: auto; display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12); border-radius: 4px;
    }
    .suggestions div { padding: 6px 10px; cursor: pointer; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .suggestions div:hover { background: #f8f9fa; }
    .table-responsive { overflow-x:auto; }
    input[type="text"] { min-width: 140px; }
  </style>
</head>
<body>
<div th:replace="fragments/commonHeader :: mainHeader"></div>

<div class="container">
  <h3 class="mb-3 text-center">Define Electives</h3>

  <div class="table-responsive">
    <table class="table table-bordered" id="electivesTable">
      <thead class="table-light">
        <tr>
          <th>Course Code</th>
          <th>Course Name</th>
          <th>Credits</th>
          <th>Faculty</th>
          <th>Slot (1â€“8)</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
      <tr th:each="tcr : ${termCourses}">
        <td>
          <span th:text="${tcr.course != null ? tcr.course.crscode : ''}"></span>
          <input type="hidden" class="courseId" th:value="${tcr.tcrcrsid}" />
        </td>
        <td><span th:text="${tcr.course != null ? (tcr.course.crsname != null ? tcr.course.crsname : tcr.course.crstitle) : ''}"></span></td>
        <td><span th:text="${tcr.course != null ? tcr.course.crscreditpoints : ''}"></span></td>
        <td style="position:relative;">
          <input type="text" class="form-control facultyName" th:value="${tcr.user != null ? tcr.user.uemail : ''}" placeholder="Search faculty">
          <input type="hidden" class="facultyId" th:value="${tcr.tcrfacultyid}"/>
          <div class="suggestions faculty-suggestions"></div>
        </td>
        <td>
          <select class="form-select slot">
            <option value="">Select</option>
            <option th:each="i : ${#numbers.sequence(1,8)}" th:value="${i}" th:text="${i}" th:selected="${i == tcr.tcrslot}"></option>
          </select>
        </td>
        <td>
          <input type="checkbox" class="deleteRow" />
          <input type="hidden" class="tcrid" th:value="${tcr.tcrid}" />
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between mt-3">
    <div>
      <button id="addRowBtn" class="btn btn-success">+ Add Row</button>
    </div>
    <div>
      <button id="saveBtn" class="btn btn-primary">Save</button>
    </div>
    <div>
      <button id="exitBtn" class="btn btn-secondary">Exit</button>
    </div>
  </div>
</div>

<script>
  // helper: attach faculty autocomplete to an input element
  function attachFacultyAutocomplete(input) {
    const suggestionBox = input.closest('td').querySelector('.faculty-suggestions');
    input.addEventListener('input', async function() {
      const q = input.value.trim();
      suggestionBox.innerHTML = '';
      if (q.length < 2) { suggestionBox.style.display='none'; return; }
      try {
        const res = await fetch(`/admin/defineElectives/searchFaculty?q=${encodeURIComponent(q)}`);
        if (!res.ok) return;
        const data = await res.json();
        data.forEach(item => {
          const d = document.createElement('div');
          d.textContent = item.name;
          d.dataset.uid = item.uid;
          d.addEventListener('click', () => {
            input.value = item.name;
            const hidden = input.closest('td').querySelector('.facultyId');
            if (hidden) hidden.value = item.uid;
            suggestionBox.style.display = 'none';
          });
          suggestionBox.appendChild(d);
        });
        suggestionBox.style.display = data.length ? 'block' : 'none';
      } catch (e) {
        console.error('faculty search failed', e);
      }
    });

    // hide on outside click
    document.addEventListener('click', (ev) => {
      if (!input.contains(ev.target) && !suggestionBox.contains(ev.target)) suggestionBox.style.display='none';
    });
  }

  // add-course row creation with course search + faculty autocomplete
  document.getElementById('addRowBtn').addEventListener('click', () => {
    const tbody = document.querySelector('#electivesTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="text" class="form-control courseSearch" placeholder="Search course by code or name">
        <div class="suggestions course-suggestions"></div>
        <input type="hidden" class="courseId" />
      </td>
      <td><input type="text" class="form-control courseName" readonly /></td>
      <td><input type="text" class="form-control courseCredits" readonly /></td>
      <td style="position:relative;">
        <input type="text" class="form-control facultyName" placeholder="Search faculty">
        <input type="hidden" class="facultyId" />
        <div class="suggestions faculty-suggestions"></div>
      </td>
      <td>
        <select class="form-select slot"><option value="">Select</option>${[1,2,3,4,5,6,7,8].map(i=>`<option value="${i}">${i}</option>`).join('')}</select>
      </td>
      <td>
        <input type="checkbox" class="deleteRow" />
        <input type="hidden" class="tcrid" value="" />
      </td>
    `;
    tbody.appendChild(tr);

    // attach faculty autocomplete
    attachFacultyAutocomplete(tr.querySelector('.facultyName'));

    // attach course search autocomplete
    attachCourseAutocomplete(tr.querySelector('.courseSearch'));
  });

  // course autocomplete (fills code, name, credits, courseId)
  function attachCourseAutocomplete(input) {
    const suggestionBox = input.closest('td').querySelector('.course-suggestions');
    input.addEventListener('input', async function() {
      const q = input.value.trim();
      suggestionBox.innerHTML = '';
      if (q.length < 2) { suggestionBox.style.display='none'; return; }
      try {
        const res = await fetch(`/admin/defineElectives/searchCourses?q=${encodeURIComponent(q)}`);
        if (!res.ok) return;
        const data = await res.json();
        data.forEach(item => {
          const d = document.createElement('div');
          d.textContent = `${item.crscode} - ${item.crsname} (${item.crscreditpoints || ''})`;
          d.addEventListener('click', () => {
            input.value = item.crscode;
            const tr = input.closest('tr');
            tr.querySelector('.courseName').value = item.crsname || '';
            tr.querySelector('.courseCredits').value = item.crscreditpoints || '';
            tr.querySelector('.courseId').value = item.crsid || '';
            suggestionBox.style.display = 'none';
          });
          suggestionBox.appendChild(d);
        });
        suggestionBox.style.display = data.length ? 'block' : 'none';
      } catch (e) {
        console.error('course search failed', e);
      }
    });
    document.addEventListener('click', (ev) => {
      if (!input.contains(ev.target) && !suggestionBox.contains(ev.target)) suggestionBox.style.display='none';
    });
  }

  // attach existing faculty inputs on page load
  document.querySelectorAll('.facultyName').forEach(attachFacultyAutocomplete);
  // attach course autocomplete for any courseSearch inputs already present (none for existing rows)
  document.querySelectorAll('.courseSearch').forEach(attachCourseAutocomplete);

  // SAVE: gather rows and POST
  document.getElementById('saveBtn').addEventListener('click', async () => {
    const rows = [];
    document.querySelectorAll('#electivesTable tbody tr').forEach(tr => {
      const tcrid = tr.querySelector('.tcrid')?.value || '';
      const crsid = tr.querySelector('.courseId')?.value || '';
      const facultyid = tr.querySelector('.facultyId')?.value || '';
      const slot = tr.querySelector('.slot') ? tr.querySelector('.slot').value : (tr.querySelector('.courseCredits') ? '' : '');
      const del = tr.querySelector('.deleteRow') ? tr.querySelector('.deleteRow').checked : false;

      // only push if has meaningful data OR marked delete
      // for new rows: must have crsid (from course search) to create
      rows.push({
        tcrid: tcrid,
        crsid: crsid,
        facultyid: facultyid,
        slot: slot,
        delete: del
      });
    });

    try {
      const res = await fetch('/admin/defineElectives/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(rows)
      });
      if (res.ok) {
        alert('Saved successfully');
        location.reload();
      } else {
        const text = await res.text();
        console.error('Save failed', text);
        alert('Error saving changes');
      }
    } catch (e) {
      console.error('Save request failed', e);
      alert('Error saving changes');
    }
  });

  document.getElementById('exitBtn').addEventListener('click', () => {
    window.location.href = '/auth/homepage';
  });
</script>
</body>
</html>




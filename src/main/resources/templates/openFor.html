<!-- <!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Open For | Admin</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/ecampus.css}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div th:replace="fragments/commonHeader :: mainHeader"></div>

<div class="container mt-4">
    <h4 class="mb-3 text-center">Define Open For (Program / Batch)</h4>

    <div class="row mb-3">
        <div class="col-md-5">
            <label class="form-label fw-bold">Program</label>
            <select id="programSelect" class="form-select">
                <option value="">-- Select Program --</option>
                <option th:each="p : ${programs}"
                        th:value="${p.prgid}"
                        th:text="${p.prgname}"></option>
            </select>
        </div>

        <div class="col-md-5">
            <label class="form-label fw-bold">Batch</label>
            <select id="batchSelect" class="form-select">
                <option value="">-- Select Batch --</option>
                
            </select>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button id="loadBtn" class="btn btn-success w-100">Load</button>
        </div>
    </div>

    <div id="tableContainer" style="display:none;">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
            <tr>
                <th style="width:5%;">#</th>
                <th style="width:10%;">TCA ID</th>
                <th style="width:15%;">Course ID</th>
                <th style="width:25%;">Elective Type</th>
                <th style="width:10%;">Delete</th>
            </tr>
            </thead>
            <tbody id="openForTableBody"></tbody>
        </table>

        <div class="d-flex justify-content-between mt-3">
            <button id="addRowBtn" class="btn btn-primary">Add Row</button>
            <button id="saveBtn" class="btn btn-success">Save Changes</button>
        </div>
    </div>

    <div id="messageArea" class="mt-3 text-center fw-bold"></div>
</div>

<script>
    const batchesEndpoint = '/admin/openFor/byProgram'; 
    $(document).ready(function () {

        $('#programSelect').change(function () {
            const prgid = $(this).val();
            $('#batchSelect').empty().append('<option value="">-- Select Batch --</option>');
            if (!prgid) return;
            $.get(batchesEndpoint + '?prgid=' + prgid, function (batches) {
                batches.forEach(b => {
                    $('#batchSelect').append(`<option value="${b.bchid}">${b.bchname}</option>`);
                });
            });
        });

        $('#loadBtn').click(function () {
            const prgid = $('#programSelect').val();
            const bchid = $('#batchSelect').val();
            if (!prgid || !bchid) {
                showMessage('Please select both Program and Batch.', 'text-danger');
                return;
            }

            $.get(`/admin/openFor/load?prgid=${prgid}&bchid=${bchid}`, function (data) {
                populateTable(data);
                $('#tableContainer').show();
                showMessage('Data loaded successfully.', 'text-success');
            }).fail(() => showMessage('Error loading data.', 'text-danger'));
        });

        $('#addRowBtn').click(function () {
            const prgid = $('#programSelect').val();
            const bchid = $('#batchSelect').val();
            $('#openForTableBody').append(`
                <tr>
                    <td></td>
                    <td class="tcaid"></td>
                    <td><input type="number" class="form-control tcatcrid" placeholder="TermCourse ID"></td>
                    <td><input type="text" class="form-control tcaelectivetype" placeholder="Type (ICTE/DEPT)"></td>
                    <td class="text-center"><input type="checkbox" class="form-check-input deleteFlag"></td>
                </tr>
            `);
        });

        $('#saveBtn').click(function () {
            const rows = [];
            $('#openForTableBody tr').each(function () {
                rows.push({
                    tcaid: $(this).find('.tcaid').text(),
                    tcatcrid: $(this).find('.tcatcrid').val(),
                    tcaprgid: $('#programSelect').val(),
                    tcabchid: $('#batchSelect').val(),
                    tcaelectivetype: $(this).find('.tcaelectivetype').val(),
                    delete: $(this).find('.deleteFlag').is(':checked')
                });
            });

            $.ajax({
                url: '/admin/openFor/save',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(rows),
                success: function () {
                    showMessage('Saved successfully.', 'text-success');
                },
                error: function () {
                    showMessage('Error saving changes.', 'text-danger');
                }
            });
        });
    });

    function populateTable(data) {
        const tbody = $('#openForTableBody');
        tbody.empty();
        data.forEach((item, idx) => {
            tbody.append(`
                <tr>
                    <td>${idx + 1}</td>
                    <td class="tcaid">${item.tcaid}</td>
                    <td><input type="number" class="form-control tcatcrid" value="${item.tcatcrid || ''}"></td>
                    <td><input type="text" class="form-control tcaelectivetype" value="${item.tcaelectivetype || ''}"></td>
                    <td class="text-center"><input type="checkbox" class="form-check-input deleteFlag"></td>
                </tr>
            `);
        });
    }

    function showMessage(msg, cls) {
        $('#messageArea').removeClass().addClass(cls).text(msg);
    }
</script>
</body>
</html> -->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Open For | Admin</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/ecampus.css}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- CSRF meta tags for AJAX -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div th:replace="fragments/commonHeader :: mainHeader"></div>

<div class="container mt-4">
    <h4 class="mb-3 text-center">Define Open For (Program / Batch)</h4>

    <div class="row mb-3">
        <div class="col-md-5">
            <label class="form-label fw-bold">Program</label>
            <select id="programSelect" class="form-select">
                <option value="">-- Select Program --</option>
                <option th:each="p : ${programs}"
                        th:value="${p.prgid}"
                        th:text="${p.prgname}"></option>
            </select>
        </div>

        <div class="col-md-5">
            <label class="form-label fw-bold">Batch</label>
            <select id="batchSelect" class="form-select">
                <option value="">-- Select Batch --</option>
            </select>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button id="loadBtn" class="btn btn-success w-100">Load</button>
        </div>
    </div>

    <div id="tableContainer" style="display:none;">
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-dark">
                <tr>
                    <th style="width:4%;">#</th>
                    <th style="width:10%;">CCODE</th>
                    <th style="width:30%;">CNAME</th>
                    <th style="width:8%;">Credits</th>
                    <th style="width:15%;">Faculty</th>
                    <th style="width:6%;">Slot</th>
                    <th style="width:15%;">Elective Type</th>
                    <th style="width:6%;">[X]</th>
                </tr>
                </thead>
                <tbody id="openForTableBody"></tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between mt-3">
            <button id="addRowBtn" class="btn btn-primary">Add Row</button>
            <button id="saveBtn" class="btn btn-success">Save Changes</button>
            <button id="exitBtn" class="btn btn-secondary">Exit</button>
        </div>
    </div>

    <div id="messageArea" class="mt-3 text-center fw-bold"></div>
</div>

<script>
    const batchesEndpoint = '/admin/openFor/byProgram';
    const loadEndpoint = '/admin/openFor/load';
    const saveEndpoint = '/admin/openFor/save';
    const electiveOptions = ['ICTE', 'TE', 'SE', 'HASSE', 'OE'];

    // CSRF tokens
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

    $(document).ready(function () {

        // populate batches when program changes
        $('#programSelect').change(function () {
            const prgid = $(this).val();
            $('#batchSelect').empty().append('<option value="">-- Select Batch --</option>');
            if (!prgid) return;
            $.get(batchesEndpoint + '?prgid=' + prgid, function (batches) {
                batches.forEach(b => {
                    $('#batchSelect').append(`<option value="${b.bchid}">${b.bchname}</option>`);
                });
            }).fail(() => showMessage('Error fetching batches', 'text-danger'));
        });

        $('#loadBtn').click(function () {
            const prgid = $('#programSelect').val();
            const bchid = $('#batchSelect').val();
            if (!prgid || !bchid) {
                showMessage('Please select both Program and Batch.', 'text-danger');
                return;
            }
            loadData(prgid, bchid);
        });

        // Add Row — allow admin to enter TermCourse ID (tcatcrid) and select elective
        $('#addRowBtn').click(function () {
            const tbody = $('#openForTableBody');
            const idx = tbody.children().length + 1;
            tbody.append(renderRow({
                tcaid: '',
                tcatcrid: '',
                crscode: '',
                crsname: '',
                credits: '',
                facultyName: '',
                slot: '',
                tcaelectivetype: 'ICTE'
            }, idx, true));
        });

        // Save
        $('#saveBtn').click(function () {
            const rows = [];
            $('#openForTableBody tr').each(function () {
                const $tr = $(this);
                rows.push({
                    tcaid: $tr.data('tcaid') || '',
                    tcatcrid: $tr.find('.tcatcrid').val() || '',
                    tcaprgid: $('#programSelect').val(),
                    tcabchid: $('#batchSelect').val(),
                    tcaelectivetype: $tr.find('.tcaelectivetype').val() || '',
                    delete: $tr.find('.deleteFlag').is(':checked') ? 'true' : 'false'
                });
            });

            $.ajax({
                url: saveEndpoint,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(rows),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                }
            }).done(function () {
                showMessage('Saved successfully.', 'text-success');
                // reload table to reflect changes
                const prgid = $('#programSelect').val();
                const bchid = $('#batchSelect').val();
                setTimeout(() => loadData(prgid, bchid), 250);
            }).fail(function (xhr) {
                console.error('Save failed', xhr);
                showMessage('Error saving changes.', 'text-danger');
            });
        });

        // Exit button
        $('#exitBtn').click(function () {
            window.location.href = '/auth/homepage';
        });
    });

    function loadData(prgid, bchid) {
        $.get(`${loadEndpoint}?prgid=${prgid}&bchid=${bchid}`, function (data) {
            populateTable(data);
            $('#tableContainer').show();
            showMessage('Data loaded successfully.', 'text-success');
        }).fail(() => showMessage('Error loading data.', 'text-danger'));
    }

    // Populate table with enriched data
    function populateTable(data) {
        const tbody = $('#openForTableBody');
        tbody.empty();
        data.forEach((item, idx) => {
            tbody.append(renderRow(item, idx + 1, false));
        });
    }

    // Render a table row. readOnlyFlag for add-row (true if newly added — course fields editable)
    function renderRow(item, idx, readOnlyFlag) {
        // item keys: tcaid,tcatcrid,crscode,crsname,credits,facultyName,slot,tcaelectivetype
        const tcaid = item.tcaid || '';
        const tcatcrid = item.tcatcrid || '';
        const crscode = item.crscode || '';
        const crsname = item.crsname || '';
        const credits = item.credits || '';
        const facultyName = item.facultyName || '';
        const slot = item.slot || '';
        const elect = item.tcaelectivetype || 'ICTE';

        // if readOnlyFlag true (new row), we allow editing tcatcrid (so admin can enter termcourse id)
        const crsDisplay = readOnlyFlag
            ? `<input type="number" class="form-control form-control-sm tcatcrid" value="${escapeHtml(tcatcrid)}" />`
            : `<input type="hidden" class="tcatcrid" value="${escapeHtml(tcatcrid)}" /> <div>${escapeHtml(crscode)}</div>`;

        const crsNameDisplay = readOnlyFlag
            ? `<input type="text" class="form-control form-control-sm crsname" value="${escapeHtml(crsname)}" />`
            : `<div>${escapeHtml(crsname)}</div>`;

        const creditsDisplay = readOnlyFlag
            ? `<input type="text" class="form-control form-control-sm credits" value="${escapeHtml(credits)}" />`
            : `<div>${escapeHtml(credits)}</div>`;

        const facultyDisplay = readOnlyFlag
            ? `<input type="text" class="form-control form-control-sm facultyName" value="${escapeHtml(facultyName)}" />`
            : `<div>${escapeHtml(facultyName)}</div>`;

        const slotDisplay = readOnlyFlag
            ? `<input type="number" min="1" max="8" class="form-control form-control-sm slot" value="${escapeHtml(slot)}" />`
            : `<div>${escapeHtml(slot)}</div>`;

        // build elective dropdown
        const electHtml = `<select class="form-select form-select-sm tcaelectivetype">
            ${electiveOptions.map(opt => `<option value="${opt}" ${opt===elect ? 'selected' : ''}>${opt}</option>`).join('')}
        </select>`;

        const row = $(`
            <tr data-tcaid="${tcaid}">
                <td>${idx}</td>
                <td>${crsDisplay}</td>
                <td>${crsNameDisplay}</td>
                <td>${creditsDisplay}</td>
                <td>${facultyDisplay}</td>
                <td>${slotDisplay}</td>
                <td>${electHtml}</td>
                <td class="text-center"><input type="checkbox" class="form-check-input deleteFlag"></td>
            </tr>
        `);

        // if row is existing (has tcaid), attach hidden tcaid data; otherwise leave data attribute empty
        if (tcaid) row.data('tcaid', tcaid);

        return row;
    }

    function showMessage(msg, cls) {
        $('#messageArea').removeClass().addClass(cls).text(msg);
    }

    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str).replace(/[&<>"'`=\/]/g, function (s) {
            return ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;',
                '/': '&#47;', '`': '&#96;', '=': '&#61;'
            })[s];
        });
    }
</script>
</body>
</html>
